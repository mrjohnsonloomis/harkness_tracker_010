<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard · Harkness Toolkit</title>
  <link rel="stylesheet" href="./assets/styles.css"/>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Harkness Toolkit</h1>
    <nav class="nav">
      <a href="./index.html" >Home</a>
      <a href="./learn.html" >Learn</a>
      <a href="./prepare.html" >Prepare</a>
      <a href="./reflect.html" >Reflect</a>
      <a href="./rubric.html" >Rubric</a>
      <a href="./dashboard.html" style="border-color:var(--accent)">Dashboard</a>
    </nav>
  </div>

  <div class="card">
    <h2>Your Growth Dashboard</h2>
    <p>Upload your cumulative CSV or XLSX file to visualize your role frequency, track your growth over time, and see your participation patterns.</p>

    <div class="card" style="background: var(--bg-secondary); margin-bottom: 2rem;">
      <h3 style="margin-top: 0;">How Data Tracking Works</h3>
      <p><strong>Important:</strong> This tool does not store data permanently. To track growth over time, maintain a master CSV/XLSX file with all your discussion data.</p>
      <ul style="margin-left: 1.5rem;">
        <li><strong>Required column:</strong> <code class="kbd">Role</code> (values: initiator, connector, questioner, evidence-finder, synthesizer, devils-advocate, bridge-builder, close-reader)</li>
        <li><strong>Optional columns:</strong> <code class="kbd">Date</code>, <code class="kbd">Student</code>, <code class="kbd">Session</code></li>
        <li><strong>After each discussion:</strong> Add new rows to your file with the date and roles observed</li>
        <li><strong>Re-upload the full file</strong> to see updated trends, aggregates, and insights</li>
      </ul>
    </div>

    <div class="flex">
      <label>Load file:
        <input type="file" id="file-input" accept=".csv,.xlsx,.xls"/>
      </label>
      <button class="btn" id="load-sample">Load Sample Data</button>
      <label>Role column:
        <select id="role-col"></select>
      </label>
      <label>Date column (optional):
        <select id="date-col"></select>
      </label>
    </div>

    <div id="aggregate-stats" class="section"></div>

    <div class="section">
      <h3>Role Frequency</h3>
      <p class="small">Total occurrences of each role across all uploaded data</p>
      <canvas id="roleChart" height="100"></canvas>
    </div>

    <div class="section">
      <h3>Trends Over Time</h3>
      <p class="small">How role participation changes across discussion sessions (requires Date column)</p>
      <canvas id="trendChart" height="100"></canvas>
    </div>

    <div class="section">
      <div id="insights"></div>
    </div>
  </div>
  <script>
    let roleChart, trendChart;
    function destroyChart(c){ if (c) { c.destroy(); } }
    function headersFromRows(rows){
      return Object.keys(rows[0] || {});
    }
    function autoDetectColumns(rows){
      const headers = headersFromRows(rows);
      const roleGuess = headers.find(h => /role/i.test(h)) || headers[0];
      const dateGuess = headers.find(h => /date|day|session/i.test(h)) || "";
      return {roleGuess, dateGuess, headers};
    }
    function normalizeRole(val){
      if(!val) return "";
      return String(val).trim().toLowerCase().replace(/\s+/g,'-');
    }
    function parseCSV(text){
      const res = Papa.parse(text, {header:true, skipEmptyLines:true});
      return res.data;
    }
    async function parseXLSXFile(fileOrBuff){
      const data = fileOrBuff instanceof ArrayBuffer ? fileOrBuff : await fileOrBuff.arrayBuffer();
      const wb = XLSX.read(data, {type:'array'});
      const sheetName = wb.SheetNames[0];
      return XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {defval:""});
    }
    function buildRoleCounts(rows, roleCol){
      const counts = {};
      rows.forEach(r=>{
        const tag = normalizeRole(r[roleCol]);
        if(!tag) return;
        counts[tag] = (counts[tag]||0)+1;
      });
      return counts;
    }
    function groupByDate(rows, roleCol, dateCol){
      const out = {};
      rows.forEach(r=>{
        const tag = normalizeRole(r[roleCol]);
        if(!tag) return;
        const d = dateCol ? new Date(r[dateCol]) : null;
        const key = d && !isNaN(d) ? d.toISOString().slice(0,10) : "unspecified";
        out[key] = out[key] || {};
        out[key][tag] = (out[key][tag]||0)+1;
      });
      return out;
    }
    function renderRoleChart(counts){
      destroyChart(roleChart);
      const labels = Object.keys(counts);
      const data = labels.map(k=>counts[k]);
      roleChart = new Chart(document.getElementById('roleChart').getContext('2d'),{
        type:'bar',
        data:{labels, datasets:[{label:'Role Frequency', data}]},
        options:{responsive:true, plugins:{legend:{display:false}}}
      });
    }
    function renderTrendChart(grouped){
      destroyChart(trendChart);
      const dates = Object.keys(grouped).sort();
      const roles = new Set();
      dates.forEach(d=>Object.keys(grouped[d]).forEach(r=>roles.add(r)));
      const datasets = Array.from(roles).map(r=>({label:r, data: dates.map(d=> grouped[d][r]||0)}));
      trendChart = new Chart(document.getElementById('trendChart').getContext('2d'),{
        type:'line',
        data:{labels:dates, datasets},
        options:{responsive:true}
      });
    }
    function renderAggregateStats(rows, counts, grouped){
      const dates = Object.keys(grouped).sort().filter(d => d !== "unspecified");
      const totalRoles = Object.values(counts).reduce((sum, val) => sum + val, 0);
      const avgPerSession = dates.length > 0 ? (totalRoles / dates.length).toFixed(1) : totalRoles;
      const entries = Object.entries(counts).sort((a,b)=>b[1]-a[1]);

      // Calculate participation equity (coefficient of variation)
      const roleCounts = Object.values(counts);
      const mean = roleCounts.reduce((a,b)=>a+b,0) / roleCounts.length;
      const variance = roleCounts.reduce((sum,val)=>sum+Math.pow(val-mean,2),0) / roleCounts.length;
      const stdDev = Math.sqrt(variance);
      const cv = (stdDev / mean * 100).toFixed(1);

      const html = `
        <div class="grid grid-3">
          <div class="card" style="background: var(--bg-secondary);">
            <h3 style="margin-top: 0; font-size: 1rem; color: var(--text-muted);">Total Observations</h3>
            <p style="font-size: 2.5rem; font-weight: 300; margin: 0; color: var(--accent); font-family: Georgia, serif;">${totalRoles}</p>
            <p class="small" style="margin: 0;">Across ${dates.length > 0 ? dates.length + ' sessions' : 'all data'}</p>
          </div>
          <div class="card" style="background: var(--bg-secondary);">
            <h3 style="margin-top: 0; font-size: 1rem; color: var(--text-muted);">Average Per Session</h3>
            <p style="font-size: 2.5rem; font-weight: 300; margin: 0; color: var(--accent); font-family: Georgia, serif;">${avgPerSession}</p>
            <p class="small" style="margin: 0;">Role observations</p>
          </div>
          <div class="card" style="background: var(--bg-secondary);">
            <h3 style="margin-top: 0; font-size: 1rem; color: var(--text-muted);">Equity Distribution</h3>
            <p style="font-size: 2.5rem; font-weight: 300; margin: 0; color: var(--accent); font-family: Georgia, serif;">${cv}%</p>
            <p class="small" style="margin: 0;">Coefficient of variation (lower = more balanced)</p>
          </div>
        </div>
      `;
      document.getElementById('aggregate-stats').innerHTML = html;
    }

    function computeInsights(counts, grouped){
      const entries = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
      const top3 = entries.slice(0,3).map(([k,v])=>`<b>${k}</b> (${v})`).join(', ');
      const bottom3 = entries.slice(-3).reverse().map(([k,v])=>`<b>${k}</b> (${v})`).join(', ');

      // simple recent change: last vs previous session
      const dates = Object.keys(grouped).sort().filter(d => d !== "unspecified");
      let deltas = [];
      if(dates.length>=2){
        const last = grouped[dates[dates.length-1]], prev = grouped[dates[dates.length-2]];
        const roles = new Set([...Object.keys(last), ...Object.keys(prev)]);
        deltas = Array.from(roles).map(r => [r,(last[r]||0)-(prev[r]||0)]).sort((a,b)=>Math.abs(b[1])-Math.abs(a[1]));
      }
      const mostUp = deltas.find(d=>d[1]>0);
      const mostDown = deltas.find(d=>d[1]<0);

      const html = `
        <h3>Insights & Recommendations</h3>
        <div class="card" style="background: var(--bg-secondary);">
          <h4 style="margin-top: 0; font-size: 1.1rem;">Most Common Roles</h4>
          <p>${top3 || 'No data yet'}</p>

          <h4 style="font-size: 1.1rem; margin-top: 1.5rem;">Least Common Roles</h4>
          <p>${bottom3 || 'No data yet'}</p>

          ${dates.length >= 2 ? `
            <h4 style="font-size: 1.1rem; margin-top: 1.5rem;">Recent Changes (${dates[dates.length-2]} → ${dates[dates.length-1]})</h4>
            <ul>
              ${mostUp ? `<li><strong>Growing:</strong> ${mostUp[0]} <span style="color: var(--accent-warm);">(+${mostUp[1]})</span></li>` : ''}
              ${mostDown ? `<li><strong>Declining:</strong> ${mostDown[0]} <span style="color: var(--text-muted);">(${mostDown[1]})</span></li>` : ''}
            </ul>
          ` : '<p class="small" style="margin-top: 1.5rem;">Add a Date column to track changes over time.</p>'}

          <h4 style="font-size: 1.1rem; margin-top: 1.5rem;">What You Can Try</h4>
          <ul>
            <li>Challenge yourself to try roles you use less often</li>
            <li>Celebrate your growth in emerging roles</li>
            <li>Use sentence stems from the Learn page to help you try new discussion moves</li>
          </ul>
        </div>
      `;
      document.getElementById('insights').innerHTML = html;
    }
    async function handleRows(rows){
      const {roleGuess, dateGuess, headers} = autoDetectColumns(rows);
      const roleSel = document.getElementById('role-col');
      const dateSel = document.getElementById('date-col');
      roleSel.innerHTML = headers.map(h=>`<option ${h===roleGuess?'selected':''}>${h}</option>`).join('');
      dateSel.innerHTML = [''].concat(headers).map(h=>`<option ${h===dateGuess?'selected':''}>${h}</option>`).join('');
      const roleCol = roleGuess; const dateCol = dateGuess || null;
      const counts = buildRoleCounts(rows, roleCol);
      const grouped = groupByDate(rows, roleCol, dateCol);
      renderAggregateStats(rows, counts, grouped);
      renderRoleChart(counts);
      renderTrendChart(grouped);
      computeInsights(counts, grouped);
    }
    // File input
    document.getElementById('file-input').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      if(file.name.endsWith('.csv')){
        const text = await file.text();
        const rows = parseCSV(text);
        handleRows(rows);
      } else {
        const rows = await parseXLSXFile(file);
        handleRows(rows);
      }
    });
    // Load sample via fetch (works on GitHub Pages when file in /data)
    document.getElementById('load-sample').addEventListener('click', async ()=>{
      try{
        const res = await fetch('./data/sample_harkness_data.xlsx');
        if(!res.ok) throw new Error('Sample not found in /data');
        const buff = await res.arrayBuffer();
        const rows = await parseXLSXFile(buff);
        handleRows(rows);
      }catch(err){
        alert(err.message + '\nTip: commit your class spreadsheet to /data and update the button path.');
      }
    });
  </script>

  <footer>© 2025 Harkness Toolkit · Static app for GitHub Pages. Upload your spreadsheet in <span class="kbd">Dashboard → Load file</span> or replace <span class="kbd">/data/sample_harkness_data.xlsx</span> in the repo.</footer>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="./assets/app.js"></script>
</body>
</html>